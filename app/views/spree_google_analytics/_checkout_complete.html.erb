<% if store_integration('google_analytics').present? %>
  <script>
    <% safely do %>
      <% if use_gtm? %>
        if (window.dataLayer) {
          <% if @order.user.present? && !try_spree_current_user %>
            dataLayer.push({
              user_id: "<%= @order.user_id %>",
              user_properties: <%= google_analytics_user_properties_json(@order.user) %>
            });
          <% end %>

          dataLayer.push(<%= google_analytics_payment_json %>);
          dataLayer.push(<%= google_analytics_purchase_json %>);
        }
      <% else %>
        if (window.gtag) {
          <% if @order.user.present? && !try_spree_current_user %>
            gtag('set', 'user_id', "<%= @order.user_id %>");
            gtag('set', 'user_properties', <%= google_analytics_user_properties_json(@order.user) %>);
          <% end %>

          gtag('event', 'add_payment_info', <%= google_analytics_payment_json %>);
          gtag('event', 'purchase', <%= google_analytics_purchase_json %>);
        }
      <% end %>
    <% end %>
  </script>
<% end %>
